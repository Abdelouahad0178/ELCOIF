<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon Élégance - Administration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .firebase-status {
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .admin-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: center;
            padding: 20px 0;
            overflow-x: auto;
            white-space: nowrap;
        }

        .admin-nav a {
            flex: 0 1 auto;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
            text-decoration: none;
        }

        .admin-nav a.active {
            color: #3498db;
            background: white;
        }

        .admin-nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .admin-nav a:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .content {
            padding: 40px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 600;
        }

        .search-bar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-bar input {
            max-width: 300px;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .appointments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .appointment-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .appointment-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .appointment-card.status-pending::before {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }

        .appointment-card.status-confirmed::before {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }

        .appointment-card.status-cancelled::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .appointment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .appointment-info {
            margin-bottom: 15px;
        }

        .appointment-info strong {
            color: #2c3e50;
            display: inline-block;
            width: 120px;
        }

        .appointment-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #27ae60;
        }

        .notification.error {
            border-left: 4px solid #e74c3c;
        }

        .notification.info {
            border-left: 4px solid #3498db;
        }

        .admin-tools {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }

        .admin-tools h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }

        .messages-dashboard {
            display: flex;
            gap: 20px;
            height: 600px;
        }

        .conversations-list {
            width: 300px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .conversations-list h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .conversation-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            position: relative;
        }

        .conversation-item:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .conversation-item.active {
            background: #f8f9ff;
            border-color: #3498db;
        }

        .conversation-phone {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .conversation-preview {
            font-size: 0.9rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .conversation-unread {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .chat-area {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.client {
            background: white;
            color: #2c3e50;
            align-self: flex-start;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }

        .message.salon {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .message.client .message-time {
            text-align: left;
        }

        .message.salon .message-time {
            text-align: right;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            padding: 12px 18px;
            resize: none;
            font-family: inherit;
            max-height: 100px;
        }

        .input-container textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: none;
        }

        .btn-send {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn-send span {
            font-size: 1.2rem;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .empty-state, .empty-messages {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3, .empty-messages h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .unread-messages {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        /* Modal pour mot de passe */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .password-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .password-modal-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .password-modal-content input {
            margin-bottom: 15px;
            padding: 12px;
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        .password-modal-content .btn {
            width: 100%;
            margin-top: 10px;
        }

        .password-modal-content .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        /* Styles pour le changement de mot de passe */
        .change-password-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .change-password-form.active {
            display: block;
        }

        .change-password-form input {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .content {
                padding: 20px;
            }

            .appointments-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .firebase-status {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 10px;
                justify-content: center;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .admin-buttons {
                flex-direction: column;
            }

            .messages-dashboard {
                flex-direction: column;
                height: auto;
            }

            .conversations-list {
                width: 100%;
                margin-bottom: 20px;
                max-height: 300px;
            }

            .chat-area {
                width: 100%;
                min-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-content">
            <h2>🔒 Accès Administration</h2>
            <input type="password" id="passwordInput" placeholder="Entrez le mot de passe" autofocus>
            <button class="btn" onclick="verifyPassword()">Se connecter</button>
            <div class="error-message" id="passwordError">Mot de passe incorrect</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="firebase-status" id="firebaseStatus">
                <div class="status-indicator status-offline" id="statusIndicator"></div>
                <span id="statusText">Connexion...</span>
            </div>
            <h1>🔧 Administration</h1>
            <p>Salon Élégance - Gestion des Rendez-vous</p>
        </div>

        <div class="admin-nav">
            <a href="#" onclick="showAllAppointments()" class="active">Tous les RDV</a>
            <a href="#" onclick="showPendingAppointments()">En attente</a>
            <a href="#" onclick="showConfirmedAppointments()">Confirmés</a>
            <a href="#" onclick="showCancelledAppointments()">Annulés</a>
            <a href="#" onclick="showTodayAppointments()">Aujourd'hui</a>
            <a href="#" onclick="showMessages()">Messages</a>
        </div>

        <div class="content">
            <!-- Statistiques -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalAppointments">0</div>
                    <div class="stat-label">Total RDV</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingAppointments">0</div>
                    <div class="stat-label">En attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="confirmedAppointments">0</div>
                    <div class="stat-label">Confirmés</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayAppointments">0</div>
                    <div class="stat-label">Aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">0 dhs</div>
                    <div class="stat-label">Chiffre d'affaires</div>
                </div>
            </div>

            <!-- Barre de recherche -->
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Rechercher par nom, téléphone..." onkeyup="filterAppointments()">
                <button class="btn btn-small" onclick="filterAppointments()">🔍 Rechercher</button>
                <button class="btn btn-secondary btn-small" onclick="clearSearch()">✖️ Effacer</button>
            </div>

            <!-- Filtres -->
            <div class="filters">
                <div class="filter-group">
                    <label>Date</label>
                    <input type="date" id="filterDate" onchange="filterAppointments()">
                </div>
                <div class="filter-group">
                    <label>Statut</label>
                    <select id="filterStatus" onchange="filterAppointments()">
                        <option value="">Tous</option>
                        <option value="pending">En attente</option>
                        <option value="confirmed">Confirmés</option>
                        <option value="cancelled">Annulés</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Service</label>
                    <select id="filterService" onchange="filterAppointments()">
                        <option value="">Tous</option>
                        <option value="coupe-homme">Coupe Homme</option>
                        <option value="coupe-femme">Coupe Femme</option>
                        <option value="coloration">Coloration</option>
                        <option value="balayage">Balayage</option>
                        <option value="brushing">Brushing</option>
                        <option value="soin">Soin Capillaire</option>
                    </select>
                </div>
            </div>

            <h2 id="sectionTitle">Tous les rendez-vous</h2>

            <!-- Liste des rendez-vous -->
            <div class="appointments-grid" id="appointmentsContainer">
                <!-- Les rendez-vous seront affichés ici -->
            </div>

            <!-- Section Messages -->
            <div id="messagesSection" style="display: none;">
                <div class="messages-dashboard">
                    <div class="conversations-list">
                        <h3>💬 Conversations</h3>
                        <div id="conversationsList">
                            <!-- Liste des conversations -->
                        </div>
                    </div>
                    
                    <div class="chat-area" id="chatArea" style="display: none;">
                        <div class="chat-container">
                            <div class="chat-header">
                                <div>
                                    <h3 id="chatClientName">Client</h3>
                                    <span id="chatClientPhone" style="opacity: 0.8;"></span>
                                </div>
                                <button class="btn btn-secondary btn-small" onclick="closeChat()">✖️ Fermer</button>
                            </div>
                            
                            <div class="chat-messages" id="adminChatMessages">
                                <!-- Messages -->
                            </div>
                            
                            <div class="chat-input">
                                <div class="input-container">
                                    <textarea id="adminMessageInput" placeholder="Écrire un message..."></textarea>
                                    <button class="btn-send" onclick="sendAdminMessage()">
                                        <span>📤</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Outils d'administration -->
                <div class="admin-tools">
                    <h3>Outils d'administration</h3>
                    <button class="btn btn-secondary" onclick="toggleChangePasswordForm()">🔑 Changer le mot de passe</button>
                    <div class="change-password-form" id="changePasswordForm">
                        <h4>Modifier le mot de passe</h4>
                        <input type="password" id="newPasswordInput" placeholder="Nouveau mot de passe">
                        <input type="password" id="confirmPasswordInput" placeholder="Confirmer le mot de passe">
                        <div class="admin-buttons">
                            <button class="btn btn-success btn-small" onclick="changePassword()">Enregistrer</button>
                            <button class="btn btn-secondary btn-small" onclick="toggleChangePasswordForm()">Annuler</button>
                        </div>
                        <div class="error-message" id="changePasswordError" style="display: none;"></div>
                    </div>
                    <div class="admin-buttons">
                        <button class="btn btn-secondary" onclick="exportData()">📊 Exporter les données</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">📁 Importer des données</button>
                        <button class="btn btn-secondary" onclick="testFirebaseConnection()">🔧 Test Firebase</button>
                        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Réinitialiser</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC2cyWkf-8L8251t8j4ExGmHv3se-K0Vh4",
            authDomain: "elcoif.firebaseapp.com",
            projectId: "elcoif",
            storageBucket: "elcoif.firebasestorage.app",
            messagingSenderId: "44236993001",
            appId: "1:44236993001:web:373ab3e43ed5025a65db78",
            measurementId: "G-Q1QS6Y5SCY"
        };

        // Variables globales
        let db = null;
        let firebaseEnabled = false;
        let appointmentsListener = null;
        let messagesListener = null;
        let isAuthenticated = false;
        const DEFAULT_PASSWORD = 'admin123';
        let appointments = [];
        let filteredAppointments = [];
        let messages = [];
        let conversations = [];
        let currentChatPhone = '';
        let currentSection = 'appointments';
        let currentFilter = 'all';

        // Services disponibles
        const services = [
            { id: 'coupe-homme', name: 'Coupe Homme', price: 25, duration: 30 },
            { id: 'coupe-femme', name: 'Coupe Femme', price: 45, duration: 45 },
            { id: 'coloration', name: 'Coloration', price: 60, duration: 90 },
            { id: 'balayage', name: 'Balayage', price: 80, duration: 120 },
            { id: 'brushing', name: 'Brushing', price: 20, duration: 30 },
            { id: 'soin', name: 'Soin Capillaire', price: 30, duration: 45 }
        ];

        // Initialisation mot de passe
        function initializePassword() {
            try {
                if (!localStorage.getItem('adminPassword')) {
                    localStorage.setItem('adminPassword', btoa(DEFAULT_PASSWORD));
                    showNotification('Mot de passe par défaut défini. Veuillez le changer après connexion.', 'info');
                }
            } catch (error) {
                console.error('Erreur lors de l\'initialisation du mot de passe:', error);
                showNotification('Erreur lors de la configuration du mot de passe.', 'error');
            }
        }

        // Vérifier mot de passe
        function verifyPassword() {
            try {
                const input = document.getElementById('passwordInput').value;
                const storedPassword = localStorage.getItem('adminPassword');
                const error = document.getElementById('passwordError');

                if (btoa(input) === storedPassword) {
                    isAuthenticated = true;
                    document.getElementById('passwordModal').style.display = 'none';
                    initializeApp();
                } else {
                    error.style.display = 'block';
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                    showNotification('Mot de passe incorrect.', 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la vérification du mot de passe:', error);
                showNotification('Erreur lors de la vérification du mot de passe.', 'error');
            }
        }

        // Afficher/masquer formulaire changement mot de passe
        function toggleChangePasswordForm() {
            try {
                const form = document.getElementById('changePasswordForm');
                form.classList.toggle('active');
                if (!form.classList.contains('active')) {
                    document.getElementById('newPasswordInput').value = '';
                    document.getElementById('confirmPasswordInput').value = '';
                    document.getElementById('changePasswordError').style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur lors de l\'affichage du formulaire de changement de mot de passe:', error);
                showNotification('Erreur dans l\'interface de changement de mot de passe.', 'error');
            }
        }

        // Changer mot de passe
        function changePassword() {
            try {
                const newPassword = document.getElementById('newPasswordInput').value;
                const confirmPassword = document.getElementById('confirmPasswordInput').value;
                const error = document.getElementById('changePasswordError');

                if (!newPassword || !confirmPassword) {
                    error.textContent = 'Veuillez remplir tous les champs.';
                    error.style.display = 'block';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    error.textContent = 'Les mots de passe ne correspondent pas.';
                    error.style.display = 'block';
                    return;
                }

                if (newPassword.length < 6) {
                    error.textContent = 'Le mot de passe doit contenir au moins 6 caractères.';
                    error.style.display = 'block';
                    return;
                }

                localStorage.setItem('adminPassword', btoa(newPassword));
                toggleChangePasswordForm();
                showNotification('Mot de passe modifié avec succès !', 'success');
            } catch (error) {
                console.error('Erreur lors du changement de mot de passe:', error);
                document.getElementById('changePasswordError').textContent = 'Erreur lors du changement de mot de passe.';
                document.getElementById('changePasswordError').style.display = 'block';
                showNotification('Erreur lors de la modification du mot de passe.', 'error');
            }
        }

        // Initialisation application
        document.addEventListener('DOMContentLoaded', function() {
            initializePassword();
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
            initializeApp();
        });

        async function initializeApp() {
            initializePassword();
            if (!isAuthenticated) {
                document.getElementById('passwordModal').style.display = 'flex';
                return;
            }
            updateFirebaseStatus(false, 'Connexion...');
            await initializeFirebase();
            await loadAppointments();
            await loadAllMessages();
            updateStats();
            setupAdminMessageInput();
        }

        // Initialisation Firebase
        async function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                return db.collection('appointments').limit(1).get()
                    .then(() => {
                        firebaseEnabled = true;
                        updateFirebaseStatus(true, 'Firebase connecté');
                        console.log('✅ Firebase connecté avec succès');
                        return true;
                    })
                    .catch((error) => {
                        console.error('Erreur lors de la connexion à Firebase:', error);
                        firebaseEnabled = false;
                        updateFirebaseStatus(false, 'Stockage local');
                        return false;
                    });
            } catch (error) {
                console.error('Erreur lors de l\'initialisation de Firebase:', error);
                firebaseEnabled = false;
                updateFirebaseStatus(false, 'Erreur de config');
                return false;
            }
        }

        function updateFirebaseStatus(isOnline, statusText) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            indicator.className = 'status-indicator ' + (isOnline ? 'status-online' : 'status-offline');
            text.textContent = statusText;
        }

        async function loadAppointments() {
            try {
                if (firebaseEnabled && db) {
                    if (appointmentsListener) {
                        appointmentsListener();
                    }
                    appointmentsListener = db.collection('appointments')
                        .orderBy('createdAt', 'desc')
                        .onSnapshot((snapshot) => {
                            appointments = snapshot.docs.map(doc => ({
                                id: doc.id,
                                source: 'firebase',
                                ...doc.data()
                            }));
                            console.log(`📊 ${appointments.length} rendez-vous chargés depuis Firebase`);
                            updateStats();
                            filterAppointments();
                        });
                } else {
                    appointments = JSON.parse(localStorage.getItem('appointments') || '[]').map(apt => ({
                        ...apt,
                        source: 'local'
                    }));
                    updateStats();
                    filterAppointments();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des rendez-vous:', error);
                appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                updateStats();
                filterAppointments();
                showNotification('Erreur lors du chargement des rendez-vous.', 'error');
            }
        }

        function updateStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const pending = appointments.filter(apt => apt.status === 'pending').length;
                const confirmed = appointments.filter(apt => apt.status === 'confirmed').length;
                const todayAppointments = appointments.filter(apt => apt.date === today && apt.status !== 'cancelled').length;
                const totalRevenue = appointments
                    .filter(apt => apt.status === 'confirmed')
                    .reduce((sum, apt) => sum + (apt.totalPrice || 0), 0);

                document.getElementById('totalAppointments').textContent = appointments.length;
                document.getElementById('pendingAppointments').textContent = pending;
                document.getElementById('confirmedAppointments').textContent = confirmed;
                document.getElementById('todayAppointments').textContent = todayAppointments;
                document.getElementById('totalRevenue').textContent = totalRevenue + ' dhs';
            } catch (error) {
                console.error('Erreur lors de la mise à jour des statistiques:', error);
                showNotification('Erreur lors de la mise à jour des statistiques.', 'error');
            }
        }

        function filterAppointments() {
            try {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const dateFilter = document.getElementById('filterDate').value;
                const statusFilter = document.getElementById('filterStatus').value;
                const serviceFilter = document.getElementById('filterService').value;

                filteredAppointments = appointments.filter(apt => {
                    const matchesSearch = !searchTerm ||
                        apt.clientName.toLowerCase().includes(searchTerm) ||
                        apt.clientPhone.replace(/\s/g, '').includes(searchTerm) ||
                        (apt.clientEmail && apt.clientEmail.toLowerCase().includes(searchTerm));
                    const matchesDate = !dateFilter || apt.date === dateFilter;
                    const matchesStatus = !statusFilter || apt.status === statusFilter;
                    const matchesService = !serviceFilter || (apt.services && apt.services.includes(serviceFilter));
                    return matchesSearch && matchesDate && matchesStatus && matchesService;
                });

                displayAppointments(filteredAppointments);
            } catch (error) {
                console.error('Erreur lors du filtrage des rendez-vous:', error);
                showNotification('Erreur lors du filtrage des rendez-vous.', 'error');
            }
        }

        function displayAppointments(appointmentsToShow) {
            const container = document.getElementById('appointmentsContainer');
            container.innerHTML = '';

            if (appointmentsToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Aucun rendez-vous trouvé</h3>
                        <p>Aucun rendez-vous ne correspond aux critères sélectionnés.</p>
                    </div>
                `;
                return;
            }

            const sortedAppointments = [...appointmentsToShow].sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time || '00:00'}`);
                const dateB = new Date(`${b.date}T${b.time || '00:00'}`);
                return dateB - dateA;
            });

            sortedAppointments.forEach(apt => {
                const card = createAppointmentCard(apt);
                container.appendChild(card);
            });
        }

        function createAppointmentCard(apt) {
            const card = document.createElement('div');
            card.className = `appointment-card status-${apt.status}`;

            const serviceNames = apt.services ? apt.services.map(serviceId => {
                const service = services.find(s => s.id === serviceId);
                return service ? service.name : serviceId;
            }).join(', ') : 'Non spécifié';

            const statusText = {
                'pending': 'En attente',
                'confirmed': 'Confirmé',
                'cancelled': 'Annulé'
            };

            const statusClasses = {
                'pending': 'status-pending',
                'confirmed': 'status-confirmed',
                'cancelled': 'status-cancelled'
            };

            const createdDate = apt.createdAt ?
                new Date(apt.createdAt).toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Non spécifié';

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <strong style="color: #2c3e50; font-size: 1.1rem;">${apt.clientName}</strong>
                    <span class="status-badge ${statusClasses[apt.status]}">${statusText[apt.status]}</span>
                </div>
                <div class="appointment-info">
                    <strong>📱 Téléphone:</strong> ${apt.clientPhone}
                </div>
                ${apt.clientEmail ? `
                <div class="appointment-info">
                    <strong>📧 Email:</strong> ${apt.clientEmail}
                </div>
                ` : ''}
                <div class="appointment-info">
                    <strong>📅 Date:</strong> ${formatDate(apt.date)}
                </div>
                <div class="appointment-info">
                    <strong>🕒 Heure:</strong> ${apt.time || 'Non spécifié'}
                </div>
                <div class="appointment-info">
                    <strong>✂️ Services:</strong> ${serviceNames}
                </div>
                <div class="appointment-info">
                    <strong>💰 Prix:</strong> ${apt.totalPrice || 0} dhs
                </div>
                <div class="appointment-info">
                    <strong>⏰ Durée:</strong> ${apt.totalDuration || 0} min
                </div>
                ${apt.notes ? `
                <div class="appointment-info">
                    <strong>📝 Notes:</strong> ${apt.notes}
                </div>
                ` : ''}
                <div class="appointment-info" style="font-size: 0.9rem; color: #6c757d;">
                    <strong>📍 Créé le:</strong> ${createdDate}
                </div>
                ${apt.cancelledAt ? `
                <div class="appointment-info" style="font-size: 0.9rem; color: #e74c3c;">
                    <strong>❌ Annulé le:</strong> ${new Date(apt.cancelledAt).toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })} ${apt.cancelledBy ? `par ${apt.cancelledBy === 'client' ? 'le client' : 'l\'admin'}` : ''}
                </div>
                ` : ''}
                <div class="appointment-actions">
                    ${apt.status === 'pending' ? `
                        <button class="btn btn-success btn-small" onclick="confirmAppointment('${apt.id}')">✅ Confirmer</button>
                        <button class="btn btn-danger btn-small" onclick="cancelAppointment('${apt.id}')">❌ Refuser</button>
                    ` : apt.status === 'confirmed' ? `
                        <button class="btn btn-danger btn-small" onclick="cancelAppointment('${apt.id}')">❌ Annuler</button>
                        <button class="btn btn-secondary btn-small" onclick="editAppointment('${apt.id}')">✏️ Modifier</button>
                    ` : `
                        <button class="btn btn-secondary btn-small" onclick="restoreAppointment('${apt.id}')">🔄 Restaurer</button>
                        <button class="btn btn-danger btn-small" onclick="deleteAppointment('${apt.id}')">🗑️ Supprimer</button>
                    `}
                </div>
            `;

            return card;
        }

        async function confirmAppointment(aptId) {
            try {
                if (firebaseEnabled && db) {
                    await db.collection('appointments').doc(aptId).update({
                        status: 'confirmed',
                        confirmedAt: new Date().toISOString(),
                        confirmedBy: 'admin'
                    });
                    showNotification('Rendez-vous confirmé avec succès !', 'success');
                } else {
                    const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    const updatedAppointments = localAppointments.map(apt =>
                        apt.id === aptId ? {
                            ...apt,
                            status: 'confirmed',
                            confirmedAt: new Date().toISOString(),
                            confirmedBy: 'admin'
                        } : apt
                    );
                    localStorage.setItem('appointments', JSON.stringify(updatedAppointments));
                    showNotification('Rendez-vous confirmé localement !', 'success');
                    await loadAppointments();
                }
            } catch (error) {
                console.error('Erreur lors de la confirmation:', error);
                showNotification('Erreur lors de la confirmation.', 'error');
            }
        }

        async function cancelAppointment(aptId) {
            if (!confirm('Êtes-vous sûr de vouloir annuler ce rendez-vous ?')) return;
            try {
                if (firebaseEnabled && db) {
                    await db.collection('appointments').doc(aptId).update({
                        status: 'cancelled',
                        cancelledAt: new Date().toISOString(),
                        cancelledBy: 'admin'
                    });
                    showNotification('Rendez-vous annulé avec succès !', 'info');
                } else {
                    const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    const updatedAppointments = localAppointments.map(apt =>
                        apt.id === aptId ? {
                            ...apt,
                            status: 'cancelled',
                            cancelledAt: new Date().toISOString(),
                            cancelledBy: 'admin'
                        } : apt
                    );
                    localStorage.setItem('appointments', JSON.stringify(updatedAppointments));
                    showNotification('Rendez-vous annulé localement !', 'info');
                    await loadAppointments();
                }
            } catch (error) {
                console.error('Erreur lors de l\'annulation:', error);
                showNotification('Erreur lors de l\'annulation.', 'error');
            }
        }

        async function restoreAppointment(aptId) {
            if (!confirm('Êtes-vous sûr de vouloir restaurer ce rendez-vous ?')) return;
            try {
                if (firebaseEnabled && db) {
                    await db.collection('appointments').doc(aptId).update({
                        status: 'confirmed',
                        restoredAt: new Date().toISOString(),
                        restoredBy: 'admin',
                        cancelledAt: firebase.firestore.FieldValue.delete(),
                        cancelledBy: firebase.firestore.FieldValue.delete()
                    });
                    showNotification('Rendez-vous restauré avec succès !', 'success');
                } else {
                    const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    const updatedAppointments = localAppointments.map(apt => {
                        if (apt.id === aptId) {
                            const { cancelledAt, cancelledBy, ...restoredApt } = apt;
                            return {
                                ...restoredApt,
                                status: 'confirmed',
                                restoredAt: new Date().toISOString(),
                                restoredBy: 'admin'
                            };
                        }
                        return apt;
                    });
                    localStorage.setItem('appointments', JSON.stringify(updatedAppointments));
                    showNotification('Rendez-vous restauré localement !', 'success');
                    await loadAppointments();
                }
            } catch (error) {
                console.error('Erreur lors de la restauration:', error);
                showNotification('Erreur lors de la restauration.', 'error');
            }
        }

        async function deleteAppointment(aptId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce rendez-vous ? Cette action est irréversible.')) return;
            try {
                if (firebaseEnabled && db) {
                    await db.collection('appointments').doc(aptId).delete();
                    showNotification('Rendez-vous supprimé avec succès !', 'info');
                } else {
                    const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    const updatedAppointments = localAppointments.filter(apt => apt.id !== aptId);
                    localStorage.setItem('appointments', JSON.stringify(updatedAppointments));
                    showNotification('Rendez-vous supprimé localement !', 'info');
                    await loadAppointments();
                }
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showNotification('Erreur lors de la suppression.', 'error');
            }
        }

        function editAppointment(aptId) {
            const apt = appointments.find(apt => apt.id === aptId);
            if (!apt) return;

            const newDate = prompt('Nouvelle date (YYYY-MM-DD):', apt.date);
            if (!newDate) return;

            const newTime = prompt('Nouvelle heure (HH:MM):', apt.time);
            if (!newTime) return;

            const newNotes = prompt('Nouvelles notes:', apt.notes || '');

            updateAppointment(aptId, {
                date: newDate,
                time: newTime,
                notes: newNotes,
                modifiedAt: new Date().toISOString(),
                modifiedBy: 'admin'
            });
        }

        async function updateAppointment(aptId, updates) {
            try {
                if (firebaseEnabled && db) {
                    await db.collection('appointments').doc(aptId).update(updates);
                    showNotification('Rendez-vous modifié avec succès !', 'success');
                } else {
                    const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    const updatedAppointments = localAppointments.map(apt =>
                        apt.id === aptId ? { ...apt, ...updates } : apt
                    );
                    localStorage.setItem('appointments', JSON.stringify(updatedAppointments));
                    showNotification('Rendez-vous modifié localement !', 'success');
                    await loadAppointments();
                }
            } catch (error) {
                console.error('Erreur lors de la modification:', error);
                showNotification('Erreur lors de la modification.', 'error');
            }
        }

        function showAllAppointments() {
            currentFilter = 'all';
            currentSection = 'appointments';
            document.getElementById('sectionTitle').textContent = 'Tous les rendez-vous';
            document.getElementById('appointmentsContainer').style.display = 'grid';
            document.getElementById('messagesSection').style.display = 'none';
            document.querySelector('.search-bar').style.display = 'flex';
            document.querySelector('.filters').style.display = 'flex';
            clearFilters();
            filterAppointments();
            updateNavActive('showAllAppointments');
        }

        function showPendingAppointments() {
            currentFilter = 'pending';
            currentSection = 'appointments';
            document.getElementById('sectionTitle').textContent = 'Rendez-vous en attente';
            document.getElementById('appointmentsContainer').style.display = 'grid';
            document.getElementById('messagesSection').style.display = 'none';
            document.querySelector('.search-bar').style.display = 'flex';
            document.querySelector('.filters').style.display = 'flex';
            document.getElementById('filterStatus').value = 'pending';
            filterAppointments();
            updateNavActive('showPendingAppointments');
        }

        function showConfirmedAppointments() {
            currentFilter = 'confirmed';
            currentSection = 'appointments';
            document.getElementById('sectionTitle').textContent = 'Rendez-vous confirmés';
            document.getElementById('appointmentsContainer').style.display = 'grid';
            document.getElementById('messagesSection').style.display = 'none';
            document.querySelector('.search-bar').style.display = 'flex';
            document.querySelector('.filters').style.display = 'flex';
            document.getElementById('filterStatus').value = 'confirmed';
            filterAppointments();
            updateNavActive('showConfirmedAppointments');
        }

        function showCancelledAppointments() {
            currentFilter = 'cancelled';
            currentSection = 'appointments';
            document.getElementById('sectionTitle').textContent = 'Rendez-vous annulés';
            document.getElementById('appointmentsContainer').style.display = 'grid';
            document.getElementById('messagesSection').style.display = 'none';
            document.querySelector('.search-bar').style.display = 'flex';
            document.querySelector('.filters').style.display = 'flex';
            document.getElementById('filterStatus').value = 'cancelled';
            filterAppointments();
            updateNavActive('showCancelledAppointments');
        }

        function showTodayAppointments() {
            currentFilter = 'today';
            currentSection = 'appointments';
            document.getElementById('sectionTitle').textContent = 'Rendez-vous d\'aujourd\'hui';
            document.getElementById('appointmentsContainer').style.display = 'grid';
            document.getElementById('messagesSection').style.display = 'none';
            document.querySelector('.search-bar').style.display = 'flex';
            document.querySelector('.filters').style.display = 'flex';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            filterAppointments();
            updateNavActive('showTodayAppointments');
        }

        function showMessages() {
            currentSection = 'messages';
            document.getElementById('sectionTitle').textContent = 'Messagerie';
            document.getElementById('appointmentsContainer').style.display = 'none';
            document.getElementById('messagesSection').style.display = 'block';
            document.querySelector('.search-bar').style.display = 'none';
            document.querySelector('.filters').style.display = 'none';
            loadAllMessages();
            updateNavActive('showMessages');
        }

        function updateNavActive(functionName) {
            document.querySelectorAll('.admin-nav a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') === functionName + '()') {
                    link.classList.add('active');
                }
            });
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterDate').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterService').value = '';
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterAppointments();
        }

        async function loadAllMessages() {
            try {
                if (firebaseEnabled && db) {
                    if (messagesListener) {
                        messagesListener();
                    }
                    messagesListener = db.collection('messages')
                        .orderBy('timestamp', 'desc')
                        .onSnapshot((snapshot) => {
                            messages = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            console.log(`💬 ${messages.length} messages chargés depuis Firebase`);
                            updateConversations();
                            updateMessagesCount();
                        });
                } else {
                    messages = JSON.parse(localStorage.getItem('messages') || '[]');
                    updateConversations();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des messages:', error);
                messages = JSON.parse(localStorage.getItem('messages') || '[]');
                updateConversations();
                showNotification('Erreur lors du chargement des messages.', 'error');
            }
        }

        function updateConversations() {
            try {
                const conversationsMap = new Map();
                messages.forEach(message => {
                    const phone = message.clientPhone;
                    if (!conversationsMap.has(phone)) {
                        conversationsMap.set(phone, {
                            clientPhone: phone,
                            messages: [],
                            lastMessage: null,
                            unreadCount: 0
                        });
                    }
                    conversationsMap.get(phone).messages.push(message);
                });

                conversations = Array.from(conversationsMap.values()).map(conv => {
                    conv.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    conv.lastMessage = conv.messages[conv.messages.length - 1];
                    conv.unreadCount = conv.messages.filter(msg =>
                        msg.sender === 'client' && !msg.read
                    ).length;
                    return conv;
                });

                conversations.sort((a, b) => {
                    if (!a.lastMessage) return 1;
                    if (!b.lastMessage) return -1;
                    return new Date(b.lastMessage.timestamp) - new Date(a.lastMessage.timestamp);
                });

                displayConversations();
            } catch (error) {
                console.error('Erreur lors de la mise à jour des conversations:', error);
                showNotification('Erreur lors de la mise à jour des conversations.', 'error');
            }
        }

        function displayConversations() {
            const container = document.getElementById('conversationsList');
            container.innerHTML = '';

            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="empty-messages">
                        <h3>💬 Aucune conversation</h3>
                        <p>Les messages des clients apparaîtront ici.</p>
                    </div>
                `;
                return;
            }

            conversations.forEach(conv => {
                const conversationDiv = document.createElement('div');
                conversationDiv.className = 'conversation-item';
                conversationDiv.onclick = () => openChat(conv.clientPhone);
                if (conv.clientPhone === currentChatPhone) {
                    conversationDiv.classList.add('active');
                }

                const lastMessageTime = conv.lastMessage ?
                    new Date(conv.lastMessage.timestamp).toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';

                const lastMessagePreview = conv.lastMessage ?
                    (conv.lastMessage.content.length > 40 ?
                        conv.lastMessage.content.substring(0, 40) + '...' :
                        conv.lastMessage.content) :
                    'Aucun message';

                conversationDiv.innerHTML = `
                    <div class="conversation-phone">${conv.clientPhone}</div>
                    <div class="conversation-preview">${lastMessagePreview}</div>
                    <div class="conversation-time">${lastMessageTime}</div>
                    ${conv.unreadCount > 0 ? `<div class="conversation-unread">${conv.unreadCount}</div>` : ''}
                `;
                container.appendChild(conversationDiv);
            });
        }

        function openChat(clientPhone) {
            try {
                currentChatPhone = clientPhone;
                const conversation = conversations.find(conv => conv.clientPhone === clientPhone);
                if (!conversation) return;

                document.getElementById('chatArea').style.display = 'flex';
                document.getElementById('chatClientName').textContent = `Chat avec le client`;
                document.getElementById('chatClientPhone').textContent = clientPhone;
                displayChatMessages(conversation.messages);
                displayConversations();
                markClientMessagesAsRead(clientPhone);
            } catch (error) {
                console.error('Erreur lors de l\'ouverture du chat:', error);
                showNotification('Erreur lors de l\'ouverture du chat.', 'error');
            }
        }

        function displayChatMessages(chatMessages) {
            const container = document.getElementById('adminChatMessages');
            container.innerHTML = '';

            if (chatMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; margin: 40px 0;">
                        <h4>💬 Nouvelle conversation</h4>
                        <p>Commencez à discuter avec ce client.</p>
                    </div>
                `;
                return;
            }

            chatMessages.forEach(message => {
                const messageElement = createAdminMessageElement(message);
                container.appendChild(messageElement);
            });

            container.scrollTop = container.scrollHeight;
        }

        function createAdminMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender}`;
            const time = new Date(message.timestamp).toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="message-time">${time}</div>
            `;
            return messageDiv;
        }

        async function sendAdminMessage() {
            try {
                const messageInput = document.getElementById('adminMessageInput');
                const content = messageInput.value.trim();
                if (!content) return;
                if (!currentChatPhone) {
                    showNotification('Veuillez sélectionner une conversation.', 'error');
                    return;
                }

                const messageData = {
                    clientPhone: currentChatPhone,
                    sender: 'salon',
                    content: content,
                    timestamp: new Date().toISOString(),
                    read: false
                };

                if (firebaseEnabled && db) {
                    await db.collection('messages').add(messageData);
                    console.log('✅ Message admin envoyé sur Firebase');
                } else {
                    const localMessages = JSON.parse(localStorage.getItem('messages') || '[]');
                    messageData.id = Date.now().toString();
                    localMessages.push(messageData);
                    localStorage.setItem('messages', JSON.stringify(localMessages));
                    console.log('💾 Message admin envoyé localement');
                    messages.push(messageData);
                    updateConversations();
                    const conversation = conversations.find(conv => conv.clientPhone === currentChatPhone);
                    if (conversation) {
                        displayChatMessages(conversation.messages);
                    }
                }

                messageInput.value = '';
                showNotification('Message envoyé !', 'success');
            } catch (error) {
                console.error('Erreur lors de l\'envoi du message:', error);
                showNotification('Erreur lors de l\'envoi du message.', 'error');
            }
        }

        async function markClientMessagesAsRead(clientPhone) {
            try {
                if (!firebaseEnabled || !db) return;
                const conversation = conversations.find(conv => conv.clientPhone === clientPhone);
                if (!conversation) return;

                const unreadClientMessages = conversation.messages.filter(msg =>
                    msg.sender === 'client' && !msg.read
                );

                if (unreadClientMessages.length === 0) return;

                const batch = db.batch();
                unreadClientMessages.forEach(msg => {
                    const msgRef = db.collection('messages').doc(msg.id);
                    batch.update(msgRef, { read: true });
                });

                await batch.commit();
                console.log(`✅ ${unreadClientMessages.length} messages marqués comme lus`);
            } catch (error) {
                console.error('Erreur lors du marquage des messages comme lus:', error);
                showNotification('Erreur lors du marquage des messages comme lus.', 'error');
            }
        }

        function updateMessagesCount() {
            try {
                const totalUnread = conversations.reduce((sum, conv) => sum + conv.unreadCount, 0);
                const messagesLink = document.querySelector('a[onclick="showMessages()"]');
                const existingBadge = messagesLink.querySelector('.unread-messages');
                if (existingBadge) {
                    existingBadge.remove();
                }
                if (totalUnread > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'unread-messages';
                    badge.textContent = totalUnread;
                    messagesLink.appendChild(badge);
                }
            } catch (error) {
                console.error('Erreur lors de la mise à jour du compteur de messages:', error);
                showNotification('Erreur lors de la mise à jour du compteur de messages.', 'error');
            }
        }

        function closeChat() {
            try {
                document.getElementById('chatArea').style.display = 'none';
                currentChatPhone = '';
                displayConversations();
            } catch (error) {
                console.error('Erreur lors de la fermeture du chat:', error);
                showNotification('Erreur lors de la fermeture du chat.', 'error');
            }
        }

        function setupAdminMessageInput() {
            try {
                const messageInput = document.getElementById('adminMessageInput');
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAdminMessage();
                    }
                });
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            } catch (error) {
                console.error('Erreur lors de la configuration de l\'entrée de message:', error);
                showNotification('Erreur lors de la configuration de l\'entrée de message.', 'error');
            }
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                console.error('Erreur lors du formatage de la date:', error);
                return dateString;
            }
        }

        function showNotification(message, type = 'info') {
            try {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <strong>${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</strong>
                    ${message}
                `;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }, 4000);
            } catch (error) {
                console.error('Erreur lors de l\'affichage de la notification:', error);
            }
        }

        async function testFirebaseConnection() {
            try {
                const statusText = document.getElementById('statusText');
                const originalText = statusText.textContent;
                statusText.textContent = 'Test en cours...';

                if (!db) {
                    throw new Error('Firebase non initialisé');
                }

                const testDoc = await db.collection('test').add({
                    timestamp: new Date(),
                    test: true
                });
                await db.collection('test').doc(testDoc.id).get();
                await db.collection('test').doc(testDoc.id).delete();

                showNotification('Test Firebase réussi ! La connexion fonctionne parfaitement.', 'success');
                updateFirebaseStatus(true, 'Firebase connecté');
                firebaseEnabled = true;
            } catch (error) {
                console.error('❌ Test Firebase échoué:', error);
                showNotification('Test Firebase échoué : ' + error.message, 'error');
                updateFirebaseStatus(false, 'Erreur Firebase');
                firebaseEnabled = false;
            } finally {
                setTimeout(() => {
                    document.getElementById('statusText').textContent = 'Firebase connecté';
                }, 2000);
            }
        }

        function exportData() {
            try {
                const dataToExport = {
                    appointments: appointments,
                    messages: messages,
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'salon-elcoif-export-' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                URL.revokeObjectURL(url);
                showNotification('Données exportées avec succès !', 'success');
            } catch (error) {
                console.error('Erreur lors de l\'exportation des données:', error);
                showNotification('Erreur lors de l\'exportation des données.', 'error');
            }
        }

        function importData(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.appointments && !importedData.messages) {
                            throw new Error('Format de données invalide');
                        }

                        const appointmentsToImport = importedData.appointments || [];
                        const messagesToImport = importedData.messages || [];

                        if (confirm(`Êtes-vous sûr de vouloir importer ${appointmentsToImport.length} rendez-vous et ${messagesToImport.length} messages ? Cela remplacera les données locales.`)) {
                            if (appointmentsToImport.length > 0) {
                                localStorage.setItem('appointments', JSON.stringify(appointmentsToImport));
                            }
                            if (messagesToImport.length > 0) {
                                localStorage.setItem('messages', JSON.stringify(messagesToImport));
                            }
                            loadAppointments();
                            loadAllMessages();
                            showNotification(`${appointmentsToImport.length} rendez-vous et ${messagesToImport.length} messages importés avec succès !`, 'success');
                        }
                    } catch (error) {
                        console.error('Erreur lors de l\'importation des données:', error);
                        showNotification('Erreur lors de l\'importation des données.', 'error');
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Erreur lors de l\'importation des données:', error);
                showNotification('Erreur lors de l\'importation des données.', 'error');
            }
        }

        function clearAllData() {
            try {
                if (!confirm('Êtes-vous sûr de vouloir supprimer toutes les données ? Cette action est irréversible.')) {
                    return;
                }
                localStorage.removeItem('appointments');
                localStorage.removeItem('messages');
                appointments = [];
                filteredAppointments = [];
                messages = [];
                conversations = [];
                updateStats();
                filterAppointments();
                updateConversations();
                showNotification('Toutes les données locales ont été supprimées.', 'info');
            } catch (error) {
                console.error('Erreur lors de la suppression des données:', error);
                showNotification('Erreur lors de la suppression des données.', 'error');
            }
        }

        window.addEventListener('beforeunload', function() {
            if (appointmentsListener) {
                appointmentsListener();
            }
            if (messagesListener) {
                messagesListener();
            }
        });

        setInterval(() => {
            if (currentSection === 'appointments') {
                updateStats();
            }
        }, 30000);

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter' && currentSection === 'messages') {
                sendAdminMessage();
            }
        });
    </script>
</body>
</html>