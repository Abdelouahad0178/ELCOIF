<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon √âl√©gance - Prendre Rendez-vous</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .firebase-status {
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            color: #3498db;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            padding: 40px;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .appointments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .appointment-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .appointment-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .appointment-card.status-pending::before {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }

        .appointment-card.status-confirmed::before {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }

        .appointment-card.status-cancelled::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .appointment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .appointment-info {
            margin-bottom: 15px;
        }

        .appointment-info strong {
            color: #2c3e50;
            display: inline-block;
            width: 100px;
        }

        .appointment-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            flex: 1;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .service-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .service-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .service-card.selected {
            border-color: #3498db;
            background: #f8f9ff;
        }

        .service-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .service-price {
            color: #3498db;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .service-duration {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .time-slot:hover {
            border-color: #3498db;
            background: #f8f9ff;
        }

        .time-slot.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .time-slot.unavailable {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #dee2e6;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #27ae60;
        }

        .notification.error {
            border-left: 4px solid #e74c3c;
        }

        .notification.info {
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .appointments-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .firebase-status {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="firebase-status" id="firebaseStatus">
                <div class="status-indicator status-offline" id="statusIndicator"></div>
                <span id="statusText">Connexion...</span>
            </div>
            <h1>‚úÇÔ∏è Salon √âl√©gance</h1>
            <p>Espace Client - Prise de Rendez-vous</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('booking')">Prendre RDV</button>
            <button class="tab" onclick="showTab('appointments')">Mes Rendez-vous</button>
        </div>

        <div class="tab-content">
            <!-- Onglet R√©servation -->
            <div id="booking" class="tab-pane active">
                <h2>Prendre un rendez-vous</h2>
                <div class="alert success" id="bookingAlert"></div>
                <div class="alert error" id="bookingError"></div>

                <form id="bookingForm">
                    <div class="form-group">
                        <label for="clientName">Nom complet *</label>
                        <input type="text" id="clientName" required placeholder="Votre nom et pr√©nom">
                    </div>

                    <div class="form-group">
                        <label for="clientPhone">T√©l√©phone *</label>
                        <input type="tel" id="clientPhone" required placeholder="06 12 34 56 78">
                    </div>

                    <div class="form-group">
                        <label for="clientEmail">Email</label>
                        <input type="email" id="clientEmail" placeholder="votre@email.com">
                    </div>

                    <div class="form-group">
                        <label>Services souhait√©s *</label>
                        <div class="services-grid" id="servicesGrid">
                            <!-- Services seront ajout√©s dynamiquement -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="appointmentDate">Date souhait√©e *</label>
                        <input type="date" id="appointmentDate" required>
                    </div>

                    <div class="form-group">
                        <label>Cr√©neaux disponibles</label>
                        <div class="time-slots" id="timeSlots">
                            <!-- Cr√©neaux seront ajout√©s dynamiquement -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes (optionnel)</label>
                        <textarea id="notes" rows="3" placeholder="Pr√©cisions particuli√®res..."></textarea>
                    </div>

                    <button type="submit" class="btn">Confirmer le rendez-vous</button>
                </form>
            </div>

            <!-- Onglet Mes Rendez-vous -->
            <div id="appointments" class="tab-pane">
                <h2>Rechercher mes rendez-vous</h2>
                
                <div class="form-group">
                    <label for="searchPhone">Num√©ro de t√©l√©phone</label>
                    <input type="tel" id="searchPhone" placeholder="06 12 34 56 78">
                    <button class="btn" onclick="searchAppointments()" style="margin-top: 15px;">Rechercher</button>
                </div>

                <div id="clientAppointments">
                    <!-- Rendez-vous du client seront affich√©s ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC2cyWkf-8L8251t8j4ExGmHv3se-K0Vh4",
            authDomain: "elcoif.firebaseapp.com",
            projectId: "elcoif",
            storageBucket: "elcoif.firebasestorage.app",
            messagingSenderId: "44236993001",
            appId: "1:44236993001:web:373ab3e43ed5025a65db78",
            measurementId: "G-Q1QS6Y5SCY"
        };

        // Variables Firebase
        let db = null;
        let firebaseEnabled = false;
        let appointmentsListener = null;

        // Services disponibles
        const services = [
            { id: 'coupe-homme', name: 'Coupe Homme', price: 25, duration: 30 },
            { id: 'coupe-femme', name: 'Coupe Femme', price: 35, duration: 45 },
            { id: 'coloration', name: 'Coloration', price: 60, duration: 90 },
            { id: 'balayage', name: 'Balayage', price: 80, duration: 120 },
            { id: 'brushing', name: 'Brushing', price: 20, duration: 30 },
            { id: 'soin', name: 'Soin Capillaire', price: 30, duration: 45 }
        ];

        // Variables globales
        let selectedServices = [];
        let selectedTime = '';
        let appointments = [];
        let currentClientPhone = '';

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            updateFirebaseStatus(false, 'Connexion...');
            await initializeFirebase();
            setupServices();
            setupDateInput();
            setupForm();
            setupFormValidation();
            await loadAppointments();
        }

        // Initialisation Firebase
        async function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                
                // Test de connexion
                return db.collection('appointments').limit(1).get()
                    .then(() => {
                        firebaseEnabled = true;
                        updateFirebaseStatus(true, 'Firebase connect√©');
                        console.log('‚úÖ Firebase connect√© avec succ√®s');
                        return true;
                    })
                    .catch((error) => {
                        console.error('‚ùå Erreur de connexion Firebase:', error);
                        firebaseEnabled = false;
                        updateFirebaseStatus(false, 'Stockage local');
                        return false;
                    });
            } catch (error) {
                console.error('‚ùå Erreur d\'initialisation Firebase:', error);
                firebaseEnabled = false;
                updateFirebaseStatus(false, 'Erreur config');
                return Promise.resolve(false);
            }
        }

        function updateFirebaseStatus(isOnline, statusText) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (isOnline) {
                indicator.className = 'status-indicator status-online';
            } else {
                indicator.className = 'status-indicator status-offline';
            }
            
            text.textContent = statusText;
        }

        function setupServices() {
            const servicesGrid = document.getElementById('servicesGrid');
            servicesGrid.innerHTML = '';

            services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.dataset.serviceId = service.id;
                serviceCard.innerHTML = `
                    <div class="service-name">${service.name}</div>
                    <div class="service-price">${service.price} dhs</div>
                    <div class="service-duration">${service.duration} min</div>
                `;
                
                serviceCard.addEventListener('click', () => toggleService(service.id));
                servicesGrid.appendChild(serviceCard);
            });
        }

        function toggleService(serviceId) {
            const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`);
            
            if (selectedServices.includes(serviceId)) {
                selectedServices = selectedServices.filter(id => id !== serviceId);
                serviceCard.classList.remove('selected');
            } else {
                selectedServices.push(serviceId);
                serviceCard.classList.add('selected');
            }
        }

        function setupDateInput() {
            const dateInput = document.getElementById('appointmentDate');
            const today = new Date();
            const maxDate = new Date();
            maxDate.setMonth(maxDate.getMonth() + 2);

            dateInput.min = today.toISOString().split('T')[0];
            dateInput.max = maxDate.toISOString().split('T')[0];

            dateInput.addEventListener('change', updateTimeSlots);
        }

        function updateTimeSlots() {
            const selectedDate = document.getElementById('appointmentDate').value;
            const timeSlotsContainer = document.getElementById('timeSlots');
            
            if (!selectedDate) {
                timeSlotsContainer.innerHTML = '';
                return;
            }

            const timeSlots = [
                '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
                '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'
            ];

            timeSlotsContainer.innerHTML = '';

            timeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.dataset.time = time;

                // V√©rifier si le cr√©neau est d√©j√† pris
                const isUnavailable = appointments.some(apt => 
                    apt.date === selectedDate && apt.time === time && apt.status !== 'cancelled'
                );

                if (isUnavailable) {
                    slot.classList.add('unavailable');
                } else {
                    slot.addEventListener('click', () => selectTimeSlot(time));
                }

                timeSlotsContainer.appendChild(slot);
            });
        }

        function selectTimeSlot(time) {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            document.querySelector(`[data-time="${time}"]`).classList.add('selected');
            selectedTime = time;
        }

        function setupForm() {
            document.getElementById('bookingForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createAppointment();
            });
        }

        async function createAppointment() {
            try {
                // Validation
                if (selectedServices.length === 0) {
                    showAlert('bookingError', 'Veuillez s√©lectionner au moins un service.');
                    return;
                }

                if (!selectedTime) {
                    showAlert('bookingError', 'Veuillez s√©lectionner un cr√©neau horaire.');
                    return;
                }

                const formData = {
                    clientName: document.getElementById('clientName').value,
                    clientPhone: document.getElementById('clientPhone').value,
                    clientEmail: document.getElementById('clientEmail').value,
                    services: selectedServices,
                    date: document.getElementById('appointmentDate').value,
                    time: selectedTime,
                    notes: document.getElementById('notes').value,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                };

                // Calculer le prix total et la dur√©e
                const selectedServiceDetails = services.filter(s => selectedServices.includes(s.id));
                formData.totalPrice = selectedServiceDetails.reduce((sum, s) => sum + s.price, 0);
                formData.totalDuration = selectedServiceDetails.reduce((sum, s) => sum + s.duration, 0);

                // Sauvegarder
                if (firebaseEnabled && db) {
                    try {
                        await db.collection('appointments').add(formData);
                        console.log('‚úÖ Rendez-vous sauv√© sur Firebase');
                        showNotification('Rendez-vous envoy√© ! En attente de confirmation.', 'success');
                    } catch (firebaseError) {
                        console.error('‚ùå Erreur Firebase:', firebaseError);
                        throw firebaseError;
                    }
                } else {
                    // Fallback vers localStorage
                    const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    formData.id = Date.now().toString();
                    localAppointments.push(formData);
                    localStorage.setItem('appointments', JSON.stringify(localAppointments));
                    console.log('üíæ Rendez-vous sauv√© localement');
                    showNotification('Rendez-vous enregistr√© localement !', 'info');
                }

                showAlert('bookingAlert', 'Rendez-vous demand√© avec succ√®s ! Vous recevrez une confirmation.');
                resetForm();
                await loadAppointments();

            } catch (error) {
                console.error('Erreur lors de la cr√©ation du rendez-vous:', error);
                showAlert('bookingError', 'Erreur lors de la r√©servation. Veuillez r√©essayer.');
            }
        }

        function resetForm() {
            document.getElementById('bookingForm').reset();
            selectedServices = [];
            selectedTime = '';
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('timeSlots').innerHTML = '';
        }

        async function loadAppointments() {
            try {
                if (firebaseEnabled && db) {
                    // √âcouter les changements en temps r√©el
                    if (appointmentsListener) {
                        appointmentsListener();
                    }

                    appointmentsListener = db.collection('appointments')
                        .orderBy('createdAt', 'desc')
                        .onSnapshot((snapshot) => {
                            appointments = snapshot.docs.map(doc => ({
                                id: doc.id,
                                source: 'firebase',
                                ...doc.data()
                            }));
                            
                            console.log(`üìä ${appointments.length} rendez-vous charg√©s depuis Firebase`);
                            updateTimeSlots();
                            
                            // Rafra√Æchir les rendez-vous du client si recherche active
                            if (currentClientPhone) {
                                displayClientAppointments();
                            }
                        });
                } else {
                    appointments = JSON.parse(localStorage.getItem('appointments') || '[]').map(apt => ({
                        ...apt,
                        source: 'local'
                    }));
                    updateTimeSlots();
                }

            } catch (error) {
                console.error('Erreur lors du chargement des rendez-vous:', error);
                appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                updateTimeSlots();
            }
        }

        async function searchAppointments() {
            const phoneNumber = document.getElementById('searchPhone').value.trim();
            
            if (!phoneNumber) {
                showAlert('bookingError', 'Veuillez saisir un num√©ro de t√©l√©phone.');
                return;
            }

            currentClientPhone = phoneNumber;
            displayClientAppointments();
        }

        function displayClientAppointments() {
            const clientAppointments = appointments.filter(apt => 
                apt.clientPhone.replace(/\s/g, '') === currentClientPhone.replace(/\s/g, '')
            );

            const container = document.getElementById('clientAppointments');
            container.innerHTML = '';

            if (clientAppointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">Aucun rendez-vous trouv√© pour ce num√©ro.</p>';
                return;
            }

            // Trier par date (plus r√©cents en premier)
            const sortedAppointments = [...clientAppointments].sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time}`);
                const dateB = new Date(`${b.date}T${b.time}`);
                return dateB - dateA;
            });

            sortedAppointments.forEach(appointment => {
                const card = createAppointmentCard(appointment);
                container.appendChild(card);
            });
        }

        function createAppointmentCard(appointment) {
            const card = document.createElement('div');
            card.className = `appointment-card status-${appointment.status}`;

            const serviceNames = appointment.services.map(serviceId => {
                const service = services.find(s => s.id === serviceId);
                return service ? service.name : serviceId;
            }).join(', ');

            const statusText = {
                'pending': 'En attente',
                'confirmed': 'Confirm√©',
                'cancelled': 'Annul√©'
            };

            const statusClass = {
                'pending': 'status-pending',
                'confirmed': 'status-confirmed',
                'cancelled': 'status-cancelled'
            };

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <strong style="color: #2c3e50;">${appointment.clientName}</strong>
                    <span class="status-badge ${statusClass[appointment.status]}">${statusText[appointment.status]}</span>
                </div>
                <div class="appointment-info">
                    <strong>Date:</strong> ${formatDate(appointment.date)}
                </div>
                <div class="appointment-info">
                    <strong>Heure:</strong> ${appointment.time}
                </div>
                <div class="appointment-info">
                    <strong>Services:</strong> ${serviceNames}
                </div>
                <div class="appointment-info">
                    <strong>Prix:</strong> ${appointment.totalPrice} dhs
                </div>
                ${appointment.notes ? `<div class="appointment-info"><strong>Notes:</strong> ${appointment.notes}</div>` : ''}
                ${appointment.status === 'pending' ? 
                    '<div class="appointment-actions"><button class="btn btn-danger btn-small" onclick="cancelClientAppointment(\'' + appointment.id + '\')">Annuler ma demande</button></div>' :
                    appointment.status === 'confirmed' ?
                    '<div class="appointment-actions"><button class="btn btn-danger btn-small" onclick="cancelClientAppointment(\'' + appointment.id + '\')">Annuler RDV</button></div>' :
                    ''
                }
            `;

            return card;
        }

        async function cancelClientAppointment(appointmentId) {
            if (!confirm('√ätes-vous s√ªr de vouloir annuler ce rendez-vous ?')) {
                return;
            }

            try {
                const appointmentToCancel = appointments.find(apt => apt.id === appointmentId);
                
                if (firebaseEnabled && db && appointmentToCancel?.source === 'firebase') {
                    try {
                        await db.collection('appointments').doc(appointmentId).update({
                            status: 'cancelled',
                            cancelledAt: new Date().toISOString(),
                            cancelledBy: 'client'
                        });
                        console.log('‚úÖ Rendez-vous annul√© sur Firebase');
                        showNotification('Rendez-vous annul√© avec succ√®s.', 'info');
                    } catch (firebaseError) {
                        console.error('‚ùå Erreur annulation Firebase:', firebaseError);
                        throw firebaseError;
                    }
                } else {
                    // Supprimer du localStorage
                    const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    const updatedAppointments = localAppointments.map(apt => 
                        apt.id === appointmentId ? {...apt, status: 'cancelled', cancelledAt: new Date().toISOString(), cancelledBy: 'client'} : apt
                    );
                    localStorage.setItem('appointments', JSON.stringify(updatedAppointments));
                    console.log('üíæ Rendez-vous annul√© localement');
                    showNotification('Rendez-vous annul√© localement.', 'info');
                }

                await loadAppointments();
                displayClientAppointments();

            } catch (error) {
                console.error('Erreur lors de l\'annulation:', error);
                showNotification('Erreur lors de l\'annulation. Veuillez r√©essayer.', 'error');
            }
        }

        function showTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            // D√©sactiver tous les boutons d'onglet
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activer l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showAlert(alertId, message) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</strong>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Validation du formulaire en temps r√©el
        function setupFormValidation() {
            const phoneInput = document.getElementById('clientPhone');
            phoneInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9\s]/g, '');
            });

            const nameInput = document.getElementById('clientName');
            nameInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^a-zA-Z√†√¢√§√©√®√™√´√Ø√Æ√¥√∂√π√ª√º√ø√ß√Ä√Ç√Ñ√â√à√ä√ã√è√é√î√ñ√ô√õ√ú≈∏√á\s-]/g, '');
            });

            const searchPhoneInput = document.getElementById('searchPhone');
            searchPhoneInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9\s]/g, '');
            });
        }

        // Nettoyage √† la fermeture de la page
        window.addEventListener('beforeunload', function() {
            if (appointmentsListener) {
                appointmentsListener();
            }
        });
    </script>
</body>
</html>